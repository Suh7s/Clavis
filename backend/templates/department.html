{% extends "base.html" %}
{% set page_title = "Department Queue" %}
{% set active_page = "department" %}
{% block title %}Clavis | Department Queue{% endblock %}

{% block content %}
<div class="space-y-6">
  <section class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">Queue Board</p>
        <h2 class="text-2xl font-semibold text-slate-800">{{ department_name if department_name is defined else 'Emergency Department' }}</h2>
      </div>
      <div class="flex items-center gap-2">
        <button class="rounded-xl border border-slate-200 px-4 py-2.5 text-sm font-semibold text-slate-600 hover:bg-slate-50">Export Queue</button>
        <button class="rounded-xl bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-indigo-700">Assign Batch</button>
      </div>
    </div>
  </section>

  <section class="grid gap-4 sm:grid-cols-2 xl:grid-cols-4">
    {% set card_label = 'Waiting Cases' %}
    {% set card_value = queue_stats.waiting if queue_stats is defined and queue_stats.waiting is defined else '46' %}
    {% set card_trend = '+6 in 1h' %}
    {% set card_trend_tone = 'negative' %}
    {% set card_subtitle = 'Awaiting pickup' %}
    {% set card_tone = 'amber' %}
    {% include 'components/card.html' %}

    {% set card_label = 'In Progress' %}
    {% set card_value = queue_stats.active if queue_stats is defined and queue_stats.active is defined else '28' %}
    {% set card_trend = '+3 started' %}
    {% set card_trend_tone = 'positive' %}
    {% set card_subtitle = 'Actively worked by team' %}
    {% set card_tone = 'indigo' %}
    {% include 'components/card.html' %}

    {% set card_label = 'Escalations' %}
    {% set card_value = queue_stats.escalated if queue_stats is defined and queue_stats.escalated is defined else '9' %}
    {% set card_trend = '2 newly escalated' %}
    {% set card_trend_tone = 'negative' %}
    {% set card_subtitle = 'Supervisor review needed' %}
    {% set card_tone = 'rose' %}
    {% include 'components/card.html' %}

    {% set card_label = 'Avg Turnaround' %}
    {% set card_value = queue_stats.turnaround if queue_stats is defined and queue_stats.turnaround is defined else '32m' %}
    {% set card_trend = '-4m improvement' %}
    {% set card_trend_tone = 'positive' %}
    {% set card_subtitle = 'Median for current shift' %}
    {% set card_tone = 'emerald' %}
    {% include 'components/card.html' %}
  </section>

  <section class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200 text-sm">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">Ticket</th>
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">Patient</th>
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">Task</th>
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">Priority</th>
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">State</th>
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">SLA</th>
            <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">Queue Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          {% if queue_items is defined and queue_items %}
            {% for item in queue_items %}
              <tr class="hover:bg-slate-50/80">
                <td class="px-4 py-3 font-medium text-slate-700">{{ item.ticket if item.ticket is defined else 'Q-' ~ item.id }}</td>
                <td class="px-4 py-3 text-slate-700">{{ item.patient_name if item.patient_name is defined else item.patient }}</td>
                <td class="px-4 py-3 text-slate-600">{{ item.task }}</td>
                <td class="px-4 py-3">
                  {% set priority_value = item.priority|default('Routine') %}
                  {% set badge_text = priority_value %}
                  {% if priority_value|lower == 'critical' %}
                    {% set badge_tone = 'rose' %}
                  {% elif priority_value|lower == 'urgent' %}
                    {% set badge_tone = 'amber' %}
                  {% else %}
                    {% set badge_tone = 'sky' %}
                  {% endif %}
                  {% include 'components/badge.html' %}
                </td>
                <td class="px-4 py-3">
                  {% set state_value = item.state|default('Queued') %}
                  {% set badge_text = state_value %}
                  {% if state_value|lower in ['overdue', 'escalated', 'blocked'] %}
                    {% set badge_tone = 'rose' %}
                  {% elif state_value|lower in ['queued', 'pending'] %}
                    {% set badge_tone = 'amber' %}
                  {% else %}
                    {% set badge_tone = 'emerald' %}
                  {% endif %}
                  {% include 'components/badge.html' %}
                </td>
                <td class="px-4 py-3 text-slate-500">{{ item.sla if item.sla is defined else '18m left' }}</td>
                <td class="px-4 py-3 text-right">
                  <div class="inline-flex items-center gap-1 rounded-xl border border-slate-200 bg-white p-1">
                    <button type="button" onclick="queueAction('claim', '{{ item.id if item.id is defined else loop.index }}')" class="rounded-lg px-2.5 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100">Claim</button>
                    <button type="button" onclick="queueAction('start', '{{ item.id if item.id is defined else loop.index }}')" class="rounded-lg px-2.5 py-1.5 text-xs font-semibold text-indigo-700 hover:bg-indigo-50">Start</button>
                    <button type="button" onclick="queueAction('complete', '{{ item.id if item.id is defined else loop.index }}')" class="rounded-lg px-2.5 py-1.5 text-xs font-semibold text-emerald-700 hover:bg-emerald-50">Complete</button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr class="hover:bg-slate-50/80">
              <td class="px-4 py-3 font-medium text-slate-700">Q-4921</td>
              <td class="px-4 py-3 text-slate-700">Arjun Menon</td>
              <td class="px-4 py-3 text-slate-600">CT Brain (with contrast)</td>
              <td class="px-4 py-3">{% set badge_text = 'Critical' %}{% set badge_tone = 'rose' %}{% include 'components/badge.html' %}</td>
              <td class="px-4 py-3">{% set badge_text = 'Queued' %}{% set badge_tone = 'amber' %}{% include 'components/badge.html' %}</td>
              <td class="px-4 py-3 text-slate-500">7m left</td>
              <td class="px-4 py-3 text-right"><div class="inline-flex items-center gap-1 rounded-xl border border-slate-200 bg-white p-1"><button type="button" onclick="queueAction('claim', '4921')" class="rounded-lg px-2.5 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100">Claim</button><button type="button" onclick="queueAction('start', '4921')" class="rounded-lg px-2.5 py-1.5 text-xs font-semibold text-indigo-700 hover:bg-indigo-50">Start</button><button type="button" onclick="queueAction('complete', '4921')" class="rounded-lg px-2.5 py-1.5 text-xs font-semibold text-emerald-700 hover:bg-emerald-50">Complete</button></div></td>
            </tr>
            <tr class="hover:bg-slate-50/80">
              <td class="px-4 py-3 font-medium text-slate-700">Q-4925</td>
              <td class="px-4 py-3 text-slate-700">Meera Gupta</td>
              <td class="px-4 py-3 text-slate-600">Troponin Panel</td>
              <td class="px-4 py-3">{% set badge_text = 'Urgent' %}{% set badge_tone = 'amber' %}{% include 'components/badge.html' %}</td>
              <td class="px-4 py-3">{% set badge_text = 'In Progress' %}{% set badge_tone = 'emerald' %}{% include 'components/badge.html' %}</td>
              <td class="px-4 py-3 text-slate-500">14m left</td>
              <td class="px-4 py-3 text-right"><div class="inline-flex items-center gap-1 rounded-xl border border-slate-200 bg-white p-1"><button type="button" onclick="queueAction('claim', '4925')" class="rounded-lg px-2.5 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100">Claim</button><button type="button" onclick="queueAction('start', '4925')" class="rounded-lg px-2.5 py-1.5 text-xs font-semibold text-indigo-700 hover:bg-indigo-50">Start</button><button type="button" onclick="queueAction('complete', '4925')" class="rounded-lg px-2.5 py-1.5 text-xs font-semibold text-emerald-700 hover:bg-emerald-50">Complete</button></div></td>
            </tr>
            <tr class="hover:bg-slate-50/80">
              <td class="px-4 py-3 font-medium text-slate-700">Q-4930</td>
              <td class="px-4 py-3 text-slate-700">Nisha Iyer</td>
              <td class="px-4 py-3 text-slate-600">Medication Reconciliation</td>
              <td class="px-4 py-3">{% set badge_text = 'Routine' %}{% set badge_tone = 'sky' %}{% include 'components/badge.html' %}</td>
              <td class="px-4 py-3">{% set badge_text = 'Escalated' %}{% set badge_tone = 'rose' %}{% include 'components/badge.html' %}</td>
              <td class="px-4 py-3 text-slate-500">Overdue</td>
              <td class="px-4 py-3 text-right"><div class="inline-flex items-center gap-1 rounded-xl border border-slate-200 bg-white p-1"><button type="button" onclick="queueAction('claim', '4930')" class="rounded-lg px-2.5 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100">Claim</button><button type="button" onclick="queueAction('start', '4930')" class="rounded-lg px-2.5 py-1.5 text-xs font-semibold text-indigo-700 hover:bg-indigo-50">Start</button><button type="button" onclick="queueAction('complete', '4930')" class="rounded-lg px-2.5 py-1.5 text-xs font-semibold text-emerald-700 hover:bg-emerald-50">Complete</button></div></td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock %}

{% block page_scripts %}
<script>
  function queueAction(action, id) {
    if (action === 'complete') {
      showToast('Queue item #' + id + ' marked complete', 'success');
      return;
    }
    if (action === 'start') {
      showToast('Queue item #' + id + ' moved to in-progress', 'info');
      return;
    }
    showToast('Queue item #' + id + ' claimed by you', 'warning');
  }
</script>
{% endblock %}
