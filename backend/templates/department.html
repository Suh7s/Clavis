{% extends "base.html" %}
{% block title %}Clavis — {{ department }} Queue{% endblock %}
{% block content %}
<a href="/" class="text-sm text-blue-600 hover:underline mb-4 inline-block">&larr; Home</a>

<div class="flex items-center justify-between mb-4">
  <div>
    <h1 class="text-2xl font-bold text-gray-800">{{ department }} Queue</h1>
    <p class="text-sm text-gray-500">Live operational queue for the department.</p>
  </div>
  <span id="wsStatus" class="text-xs px-3 py-1.5 rounded-full bg-gray-200 text-gray-500">Connecting...</span>
</div>

<div id="queueSummary" class="grid grid-cols-4 gap-3 mb-6"></div>
<div id="queueList" class="space-y-3"></div>

<script>
const DEPARTMENT = {{ department|tojson }};

const TRANSITIONS = {
  DIAGNOSTIC:        { REQUESTED: ['SAMPLE_COLLECTED', 'PROCESSING', 'CANCELLED'], SAMPLE_COLLECTED: ['PROCESSING'], PROCESSING: ['COMPLETED', 'FAILED'] },
  MEDICATION:        { PRESCRIBED: ['DISPENSED', 'CANCELLED'], DISPENSED: ['ADMINISTERED'] },
  REFERRAL:          { INITIATED: ['ACKNOWLEDGED', 'CANCELLED'], ACKNOWLEDGED: ['REVIEWED'], REVIEWED: ['CLOSED'] },
  CARE_INSTRUCTION:  { ISSUED: ['ACKNOWLEDGED', 'CANCELLED'], ACKNOWLEDGED: ['IN_PROGRESS'], IN_PROGRESS: ['COMPLETED'] },
  VITALS_REQUEST:    { REQUESTED: ['RECORDED', 'CANCELLED'] },
};

let customTypes = [];
let customTransitions = {};

const PRIORITY_COLORS = { ROUTINE: 'bg-gray-100 text-gray-600', URGENT: 'bg-amber-100 text-amber-700', CRITICAL: 'bg-red-100 text-red-700' };
const STATE_COLORS = {
  COMPLETED: 'bg-green-100 text-green-700',
  ADMINISTERED: 'bg-green-100 text-green-700',
  CLOSED: 'bg-green-100 text-green-700',
  RECORDED: 'bg-green-100 text-green-700',
  CANCELLED: 'bg-gray-100 text-gray-600',
  FAILED: 'bg-red-100 text-red-700',
};

function escapeHtml(value) {
  return String(value ?? '').replace(/[&<>"']/g, (ch) => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;',
  }[ch]));
}

function getNextStates(a) {
  if (a.custom_action_type_id) {
    const ct = customTransitions[a.custom_action_type_id];
    return ct ? (ct[a.current_state] || []) : [];
  }
  return (TRANSITIONS[a.action_type] || {})[a.current_state] || [];
}

function stateBadge(state) {
  const color = STATE_COLORS[state] || 'bg-blue-100 text-blue-700';
  return `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${color}">${escapeHtml(state)}</span>`;
}

function priorityBadge(priority) {
  return `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${PRIORITY_COLORS[priority]}">${escapeHtml(priority)}</span>`;
}

function displayName(a) {
  if (a.custom_type_name) return a.custom_type_name;
  return (a.action_type || '').replace(/_/g, ' ');
}

async function loadCustomTypes() {
  const res = await fetch('/custom-action-types');
  if (!res.ok) {
    customTypes = [];
    customTransitions = {};
    return;
  }
  customTypes = await res.json();
  customTransitions = {};
  for (const ct of customTypes) {
    const trans = {};
    for (let i = 0; i < ct.states.length - 1; i++) {
      trans[ct.states[i]] = [ct.states[i + 1]];
    }
    customTransitions[ct.id] = trans;
  }
}

async function transitionAction(actionId, newState) {
  const notes = prompt(`Notes for transition to ${newState} (optional):`) || '';
  const res = await fetch(`/actions/${actionId}/transition`, {
    method: 'PATCH',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ new_state: newState, notes })
  });
  if (!res.ok) {
    const err = await res.json();
    alert(err.detail || err.error || 'Transition failed');
    return;
  }
}

function renderSummary(actions) {
  const overdue = actions.filter(a => a.is_overdue).length;
  const critical = actions.filter(a => a.priority === 'CRITICAL').length;
  const inProgress = actions.filter(a => !a.is_terminal).length;
  document.getElementById('queueSummary').innerHTML = [
    ['Queue Size', actions.length, 'bg-white'],
    ['In Progress', inProgress, 'bg-blue-50'],
    ['Critical', critical, critical ? 'bg-amber-50' : 'bg-white'],
    ['Overdue', overdue, overdue ? 'bg-red-50' : 'bg-white'],
  ].map(([label, value, bg]) => `
    <div class="${bg} border rounded-lg px-4 py-3 text-center">
      <div class="text-2xl font-bold text-gray-800">${value}</div>
      <div class="text-xs text-gray-500">${escapeHtml(label)}</div>
    </div>
  `).join('');
}

async function loadQueue() {
  const res = await fetch(`/actions/department/${encodeURIComponent(DEPARTMENT)}`);
  if (res.status === 403) {
    document.getElementById('queueSummary').innerHTML = '';
    document.getElementById('queueList').innerHTML = '<p class="text-red-600 text-sm">Your role cannot access this department queue.</p>';
    return;
  }
  if (!res.ok) {
    document.getElementById('queueSummary').innerHTML = '';
    document.getElementById('queueList').innerHTML = '<p class="text-red-600 text-sm">Failed to load department queue.</p>';
    return;
  }
  const actions = await res.json();
  renderSummary(actions);
  const el = document.getElementById('queueList');

  if (actions.length === 0) {
    el.innerHTML = '<p class="text-gray-500 text-sm">No pending actions for this department.</p>';
    return;
  }

  el.innerHTML = actions.map(a => {
    const nextStates = getNextStates(a);
    const buttons = nextStates.map(state => `
      <button onclick="transitionAction(${a.id}, '${state}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">${state}</button>
    `).join('');
    const notesDisplay = a.notes ? `<p class="text-sm text-gray-500 mt-1">${escapeHtml(a.notes)}</p>` : '';
    const patientLink = `<a href="/patients/${a.patient_id}/view" class="text-blue-600 hover:underline">Patient #${a.patient_id}</a>`;

    return `
      <div class="bg-white border rounded-lg px-5 py-4 ${a.is_overdue ? 'border-red-300 bg-red-50' : ''}">
        <div class="flex items-start justify-between gap-4">
          <div class="flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-xs uppercase text-gray-400 tracking-wide">${escapeHtml(displayName(a))}</span>
              ${stateBadge(a.current_state)}
              ${priorityBadge(a.priority)}
              ${a.is_overdue ? '<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-red-600 text-white">OVERDUE</span>' : ''}
            </div>
            <div class="mt-1 font-semibold text-gray-800">${a.title ? escapeHtml(a.title) : '<span class="italic text-gray-400">No title</span>'}</div>
            ${notesDisplay}
          </div>
          <div class="text-xs text-gray-500 text-right shrink-0">
            <div>${patientLink}</div>
            <div>Route: ${escapeHtml(a.queue_department || a.department)}</div>
            <div>SLA: ${a.sla_deadline ? new Date(a.sla_deadline + 'Z').toLocaleString() : '—'}</div>
            <div>#${a.id}</div>
          </div>
        </div>
        ${buttons ? `<div class="flex gap-2 mt-3">${buttons}</div>` : ''}
      </div>
    `;
  }).join('');
}

let ws;
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const token = getAuthToken() || '';
  const wsUrl = `${proto}//${location.host}/ws/department/${encodeURIComponent(DEPARTMENT)}?token=${encodeURIComponent(token)}`;
  const wsEl = document.getElementById('wsStatus');
  ws = new WebSocket(wsUrl);
  ws.onopen = () => {
    wsEl.textContent = 'Live';
    wsEl.className = 'text-xs px-3 py-1.5 rounded-full bg-green-100 text-green-700';
  };
  ws.onmessage = () => { loadQueue(); };
  ws.onclose = () => {
    wsEl.textContent = 'Reconnecting...';
    wsEl.className = 'text-xs px-3 py-1.5 rounded-full bg-amber-100 text-amber-700';
    setTimeout(connectWS, 2000);
  };
}

loadCustomTypes().then(() => {
  connectWS();
  loadQueue();
});
</script>
{% endblock %}
