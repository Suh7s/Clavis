{% extends "base.html" %}
{% set page_title = "Patient #" ~ patient_id %}
{% set active_page = "patients" %}
{% block title %}Clavis | Patient #{{ patient_id }}{% endblock %}
{% block content %}

<a href="/patients/view" class="mb-4 inline-flex items-center rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm font-medium text-slate-600 hover:bg-slate-50">&larr; All Patients</a>

<div id="patientHeader" class="mb-6"></div>
<div id="interactionWarnings" class="hidden mb-4"></div>

<div id="summary" class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-2"></div>
<div id="summaryText" class="text-sm text-gray-600 dark:text-gray-400 mb-6"></div>

<div id="dischargePanel" class="hidden mb-6 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4">
  <h3 class="font-semibold text-amber-800 dark:text-amber-100 mb-2">Discharge Patient</h3>
  <p class="text-sm text-amber-700 dark:text-amber-200 mb-3">All actions are terminal. Add optional discharge notes.</p>
  <textarea id="dischargeNotes" rows="3" class="w-full border dark:border-gray-600 rounded px-3 py-2 text-sm dark:bg-gray-700 dark:text-gray-100" placeholder="Discharge summary / follow-up instructions"></textarea>
  <div class="mt-3 flex gap-2">
    <button onclick="submitDischarge()" class="bg-amber-600 text-white text-sm px-4 py-2 rounded hover:bg-amber-700">Confirm Discharge</button>
    <button onclick="document.getElementById('dischargePanel').classList.add('hidden')" class="border border-gray-300 dark:border-gray-700 text-sm px-4 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-800">Cancel</button>
  </div>
</div>

<div class="flex items-center justify-between mb-4">
  <h2 class="text-lg font-bold text-gray-800 dark:text-gray-100">Clinical Actions</h2>
  <div class="flex gap-2">
    <button id="btnCustomType" onclick="togglePanel('customTypeForm')"
      class="border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-200 text-sm px-4 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800">
      + Custom Type
    </button>
    <button id="btnNewAction" onclick="togglePanel('newActionForm')"
      class="bg-blue-600 text-white text-sm px-4 py-2 rounded-lg hover:bg-blue-700">
      + New Action
    </button>
  </div>
</div>

<div id="customTypeForm" class="hidden mb-6 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg p-5">
  <h3 class="font-semibold text-gray-700 dark:text-gray-200 mb-3">Define Custom Action Type</h3>
  <form onsubmit="createCustomType(event)" class="space-y-3">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Name</label>
        <input id="ctName" required class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100" placeholder="e.g. BLOOD_TRANSFUSION">
      </div>
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Department</label>
        <input id="ctDept" required class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100" placeholder="e.g. Blood Bank">
      </div>
    </div>
    <div>
      <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">States (comma-separated, in order)</label>
      <input id="ctStates" required class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100" placeholder="e.g. ORDERED, CROSS_MATCHED, TRANSFUSING, COMPLETED">
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">SLA Routine (min)</label>
        <input id="ctSlaR" type="number" value="120" class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100">
      </div>
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">SLA Urgent (min)</label>
        <input id="ctSlaU" type="number" value="30" class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100">
      </div>
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">SLA Critical (min)</label>
        <input id="ctSlaC" type="number" value="10" class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100">
      </div>
    </div>
    <button type="submit" class="bg-indigo-600 text-white text-sm px-4 py-1.5 rounded hover:bg-indigo-700">Create Type</button>
  </form>
</div>

<div id="newActionForm" class="hidden mb-6 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg p-5">
  <h3 class="font-semibold text-gray-700 dark:text-gray-200 mb-3">Create Action</h3>
  <form onsubmit="createAction(event)" class="space-y-3">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Type</label>
        <select id="aType" class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100">
          <option value="DIAGNOSTIC">Diagnostic</option>
          <option value="MEDICATION">Medication</option>
          <option value="REFERRAL">Referral</option>
          <option value="CARE_INSTRUCTION">Care Instruction</option>
          <option value="VITALS_REQUEST">Vitals Request</option>
        </select>
      </div>
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Priority</label>
        <select id="aPriority" class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100">
          <option value="ROUTINE">Routine</option>
          <option value="URGENT">Urgent</option>
          <option value="CRITICAL">Critical</option>
        </select>
      </div>
    </div>
    <div>
      <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Title</label>
      <input id="aTitle" required class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100" placeholder="e.g. Chest X-Ray, Amoxicillin 500mg">
    </div>
    <div>
      <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Department Target (optional)</label>
      <input id="aDeptTarget" class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100" placeholder="Leave empty for auto-routing">
    </div>
    <div>
      <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Notes</label>
      <textarea id="aNotes" rows="2" class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100" placeholder="Clinical notes, dosage, instructions..."></textarea>
    </div>
    <button type="submit" class="bg-green-600 text-white text-sm px-4 py-1.5 rounded hover:bg-green-700">Create Action</button>
  </form>
</div>

<div id="actionList" class="space-y-3 mb-8"></div>

<div id="editModal" class="clavis-modal hidden fixed inset-0 bg-black/30 flex items-center justify-center z-50">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-md border dark:border-gray-700">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-bold text-gray-800 dark:text-gray-100">Edit Action <span id="editId"></span></h3>
      <button onclick="closeEdit()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-xl">&times;</button>
    </div>
    <form onsubmit="saveEdit(event)" class="space-y-3">
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Title</label>
        <input id="editTitle" class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100">
      </div>
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Notes</label>
        <textarea id="editNotes" rows="3" class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100"></textarea>
      </div>
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Priority</label>
        <select id="editPriority" class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100">
          <option value="ROUTINE">Routine</option>
          <option value="URGENT">Urgent</option>
          <option value="CRITICAL">Critical</option>
        </select>
      </div>
      <div class="flex gap-2 justify-end">
        <button type="button" onclick="closeEdit()" class="border border-gray-300 dark:border-gray-700 text-gray-600 dark:text-gray-200 text-sm px-4 py-1.5 rounded hover:bg-gray-50 dark:hover:bg-gray-800">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white text-sm px-4 py-1.5 rounded hover:bg-blue-700">Save</button>
      </div>
    </form>
  </div>
</div>

<div id="transitionModal" class="clavis-modal hidden fixed inset-0 bg-black/30 flex items-center justify-center z-50">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-md border dark:border-gray-700">
    <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-1">Transition Action <span id="transId"></span></h3>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4" id="transLabel"></p>
    <form onsubmit="confirmTransition(event)" class="space-y-3">
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Notes (optional)</label>
        <textarea id="transNotes" rows="2" class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100" placeholder="Observations, results, remarks..."></textarea>
      </div>
      <div class="flex gap-2 justify-end">
        <button type="button" onclick="closeTransition()" class="border border-gray-300 dark:border-gray-700 text-gray-600 dark:text-gray-200 text-sm px-4 py-1.5 rounded hover:bg-gray-50 dark:hover:bg-gray-800">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white text-sm px-4 py-1.5 rounded hover:bg-blue-700">Confirm</button>
      </div>
    </form>
  </div>
</div>

<div id="transferModal" class="clavis-modal hidden fixed inset-0 bg-black/30 flex items-center justify-center z-50">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-lg border dark:border-gray-700">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold text-gray-800 dark:text-gray-100">Transfer / Handoff</h3>
      <button onclick="closeTransferModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-xl">&times;</button>
    </div>
    <form onsubmit="submitTransfer(event)" class="space-y-3">
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">To Doctor</label>
        <select id="transferDoctor" class="w-full border dark:border-gray-600 rounded px-3 py-2 text-sm dark:bg-gray-700 dark:text-gray-100">
          <option value="">Keep current doctor</option>
        </select>
      </div>
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">To Ward</label>
        <input id="transferWard" class="w-full border dark:border-gray-600 rounded px-3 py-2 text-sm dark:bg-gray-700 dark:text-gray-100" placeholder="e.g. ICU - Bed 12">
      </div>
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Reason</label>
        <textarea id="transferReason" rows="3" class="w-full border dark:border-gray-600 rounded px-3 py-2 text-sm dark:bg-gray-700 dark:text-gray-100" placeholder="Clinical reason for handoff"></textarea>
      </div>
      <div class="flex gap-2 justify-end">
        <button type="button" onclick="closeTransferModal()" class="border border-gray-300 dark:border-gray-700 text-sm px-4 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-800">Cancel</button>
        <button type="submit" class="bg-indigo-600 text-white text-sm px-4 py-2 rounded hover:bg-indigo-700">Transfer</button>
      </div>
    </form>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-8">
  <div class="bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-bold text-gray-800 dark:text-gray-100">Transfer History</h2>
      <button id="openTransferBtn" onclick="openTransferModal()" class="border border-gray-300 dark:border-gray-700 text-sm px-3 py-1.5 rounded hover:bg-gray-50 dark:hover:bg-gray-800">+ Transfer</button>
    </div>
    <div id="transferList" class="space-y-2"></div>
  </div>

  <div class="bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg p-4">
    <h2 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-3">Attachments</h2>
    <form onsubmit="uploadAttachment(event)" class="space-y-2 mb-3">
      <input id="attachmentFile" type="file" required class="w-full text-sm text-gray-700 dark:text-gray-200" />
      <input id="attachmentActionId" type="number" min="1" class="w-full border dark:border-gray-600 rounded px-3 py-1.5 text-sm dark:bg-gray-700 dark:text-gray-100" placeholder="Optional action ID" />
      <button type="submit" class="bg-emerald-600 text-white text-sm px-4 py-1.5 rounded hover:bg-emerald-700">Upload</button>
    </form>
    <div id="attachmentList" class="space-y-2"></div>
  </div>
</div>

<div class="flex items-center justify-between mb-3">
  <h2 class="text-lg font-bold text-gray-800 dark:text-gray-100">Clinical Notes</h2>
  <button onclick="document.getElementById('noteForm').classList.toggle('hidden')"
    class="border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-200 text-sm px-4 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800">+ Add Note</button>
</div>
<div id="noteForm" class="hidden mb-4 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg p-4">
  <form onsubmit="createNote(event)" class="space-y-3">
    <div>
      <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Type</label>
      <select id="noteType" class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm dark:bg-gray-700 dark:text-gray-100">
        <option value="general">General</option>
        <option value="clinical">Clinical</option>
        <option value="progress">Progress</option>
        <option value="discharge">Discharge</option>
      </select>
    </div>
    <div>
      <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Content</label>
      <textarea id="noteContent" rows="3" required class="border dark:border-gray-600 rounded px-3 py-1.5 text-sm w-full dark:bg-gray-700 dark:text-gray-100" placeholder="Enter clinical notes..."></textarea>
    </div>
    <button type="submit" class="bg-green-600 text-white text-sm px-4 py-1.5 rounded hover:bg-green-700">Save Note</button>
  </form>
</div>
<div id="notesList" class="space-y-2 mb-8"></div>

<h2 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-3">Event Timeline</h2>
<div id="timeline" class="space-y-2 mb-8"></div>

<div id="wsStatus" class="fixed bottom-4 right-4 text-xs px-3 py-1.5 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-300"></div>

<script>
const PID = {{ patient_id }};
const CURRENT_USER = getCurrentUser();
let editingActionId = null;
let pendingTransition = null;
let customTypes = [];
let customTransitions = {};
let currentPatient = null;

const TRANSITIONS = {
  DIAGNOSTIC:        { REQUESTED: ['SAMPLE_COLLECTED', 'PROCESSING', 'CANCELLED'], SAMPLE_COLLECTED: ['PROCESSING'], PROCESSING: ['COMPLETED', 'FAILED'] },
  MEDICATION:        { PRESCRIBED: ['DISPENSED', 'CANCELLED'], DISPENSED: ['ADMINISTERED'] },
  REFERRAL:          { INITIATED: ['ACKNOWLEDGED', 'CANCELLED'], ACKNOWLEDGED: ['REVIEWED'], REVIEWED: ['CLOSED'] },
  CARE_INSTRUCTION:  { ISSUED: ['ACKNOWLEDGED', 'CANCELLED'], ACKNOWLEDGED: ['IN_PROGRESS'], IN_PROGRESS: ['COMPLETED'] },
  VITALS_REQUEST:    { REQUESTED: ['RECORDED', 'CANCELLED'] },
};

const PRIORITY_COLORS = { ROUTINE: 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200', URGENT: 'bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-200', CRITICAL: 'bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-200' };
const STATE_COLORS = {
  COMPLETED: 'bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-200',
  ADMINISTERED: 'bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-200',
  CLOSED: 'bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-200',
  RECORDED: 'bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-200',
  CANCELLED: 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300',
  FAILED: 'bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-200',
};

function escapeHtml(value) {
  return String(value ?? '').replace(/[&<>"']/g, (ch) => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;',
  }[ch]));
}

function togglePanel(id) {
  document.getElementById(id).classList.toggle('hidden');
}

function stateBadge(state, terminalState) {
  const isTerminal = terminalState ? state === terminalState : !!STATE_COLORS[state];
  const color = isTerminal ? 'bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-200' : (STATE_COLORS[state] || 'bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-200');
  return `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${color}">${escapeHtml(state)}</span>`;
}

function priorityBadge(p) {
  return `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${PRIORITY_COLORS[p] || PRIORITY_COLORS.ROUTINE}">${escapeHtml(p)}</span>`;
}

function getNextStates(a) {
  if (a.custom_action_type_id) {
    const ct = customTransitions[a.custom_action_type_id];
    return ct ? (ct[a.current_state] || []) : [];
  }
  return (TRANSITIONS[a.action_type] || {})[a.current_state] || [];
}

function getTerminalState(a) {
  if (a.custom_action_type_id) {
    const ct = customTypes.find(c => c.id === a.custom_action_type_id);
    return ct ? ct.terminal_state : null;
  }
  return null;
}

function getDisplayName(a) {
  if (a.custom_type_name) return a.custom_type_name;
  return (a.action_type || '').replace(/_/g, ' ');
}

function canManagePatient() {
  return CURRENT_USER && ['doctor', 'admin'].includes(CURRENT_USER.role);
}

async function loadCustomTypes() {
  const res = await fetch('/custom-action-types');
  if (!res.ok) {
    customTypes = [];
    customTransitions = {};
    updateTypeDropdown();
    return;
  }
  customTypes = await res.json();
  customTransitions = {};
  for (const ct of customTypes) {
    const trans = {};
    for (let i = 0; i < ct.states.length - 1; i++) {
      trans[ct.states[i]] = [ct.states[i + 1]];
    }
    customTransitions[ct.id] = trans;
  }
  updateTypeDropdown();
}

function updateTypeDropdown() {
  const sel = document.getElementById('aType');
  sel.querySelectorAll('option[data-custom]').forEach(o => o.remove());
  for (const ct of customTypes) {
    const opt = document.createElement('option');
    opt.value = `custom:${ct.id}`;
    opt.textContent = ct.name;
    opt.setAttribute('data-custom', 'true');
    sel.appendChild(opt);
  }
}

function renderPatientHeader(data) {
  const extras = [data.blood_group, data.ward].filter(Boolean).join(' · ');
  const admDate = data.admission_date ? new Date(data.admission_date + (String(data.admission_date).endsWith('Z') ? '' : 'Z')).toLocaleDateString() : null;
  const status = data.admission_status || 'ADMITTED';
  const statusClass = {
    ADMITTED: 'bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-200',
    DISCHARGED: 'bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-200',
    TRANSFERRED: 'bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-200',
  }[status] || 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200';

  const allTerminal = (data.actions || []).length > 0 && data.actions.every((action) => action.is_terminal);
  const canDischarge = canManagePatient() && status !== 'DISCHARGED' && allTerminal;
  const showTransfer = canManagePatient() && status !== 'DISCHARGED';

  const actions = [];
  actions.push('<button onclick="downloadPatientExport(\'csv\')" class="border border-gray-300 dark:border-gray-700 text-sm px-3 py-1.5 rounded hover:bg-gray-50 dark:hover:bg-gray-800">Export CSV</button>');
  actions.push('<button onclick="downloadPatientExport(\'pdf\')" class="border border-gray-300 dark:border-gray-700 text-sm px-3 py-1.5 rounded hover:bg-gray-50 dark:hover:bg-gray-800">Export PDF</button>');
  if (showTransfer) {
    actions.push('<button onclick="openTransferModal()" class="border border-indigo-300 dark:border-indigo-700 text-indigo-700 dark:text-indigo-200 text-sm px-3 py-1.5 rounded hover:bg-indigo-50 dark:hover:bg-indigo-900/20">Transfer</button>');
  }
  if (canDischarge) {
    actions.push('<button onclick="openDischargePanel()" class="border border-amber-300 dark:border-amber-700 text-amber-700 dark:text-amber-200 text-sm px-3 py-1.5 rounded hover:bg-amber-50 dark:hover:bg-amber-900/20">Discharge</button>');
  }

  const dischargeMeta = status === 'DISCHARGED'
    ? `<p class="text-xs text-green-700 dark:text-green-300 mt-1">Discharged ${data.discharge_date ? new Date(data.discharge_date + 'Z').toLocaleString() : ''}</p>`
    : '';

  document.getElementById('patientHeader').innerHTML = `
    <div class="flex items-start justify-between gap-3 flex-wrap">
      <div>
        <div class="flex items-center gap-2 flex-wrap">
          <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">${escapeHtml(data.name)}</h1>
          <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusClass}">${escapeHtml(status)}</span>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400">${data.age}y, ${escapeHtml(data.gender)} — Patient #${data.id}${extras ? ' · ' + escapeHtml(extras) : ''}${admDate ? ' · Admitted ' + escapeHtml(admDate) : ''}</p>
        ${dischargeMeta}
      </div>
      <div class="flex gap-2 flex-wrap">${actions.join('')}</div>
    </div>
  `;

  document.getElementById('openTransferBtn').classList.toggle('hidden', !showTransfer);
}

function renderInteractionWarnings(warnings) {
  const el = document.getElementById('interactionWarnings');
  if (!warnings || warnings.length === 0) {
    el.classList.add('hidden');
    el.innerHTML = '';
    return;
  }
  el.classList.remove('hidden');
  el.innerHTML = `
    <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg px-4 py-3">
      <h3 class="text-sm font-semibold text-amber-800 dark:text-amber-100 mb-1">Medication Interaction Warning</h3>
      <ul class="text-sm text-amber-700 dark:text-amber-200 list-disc ml-5">
        ${warnings.map((w) => `<li>${escapeHtml(w.message || `${w.new_drug} with ${w.existing_drug}`)}</li>`).join('')}
      </ul>
    </div>
  `;
}

async function loadPatient() {
  const res = await fetch(`/patients/${PID}`);
  if (!res.ok) {
    document.getElementById('patientHeader').innerHTML = '<h1 class="text-xl font-bold text-red-700">Failed to load patient.</h1>';
    document.getElementById('actionList').innerHTML = '<p class="text-red-600 text-sm">Unable to load actions right now.</p>';
    return;
  }
  const data = await res.json();
  currentPatient = data;
  renderPatientHeader(data);

  const el = document.getElementById('actionList');
  if (data.actions.length === 0) {
    el.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">No actions yet.</p>';
    return;
  }

  el.innerHTML = data.actions.map(a => {
    const nextStates = getNextStates(a);
    const terminal = getTerminalState(a);
    const isComplete = nextStates.length === 0;
    const transitionUI = !isComplete
      ? `<div class="flex gap-2 mt-3 flex-wrap">${nextStates.map(s =>
          `<button onclick="openTransition(${a.id}, '${a.current_state}', '${s}')"
            class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition">${s}</button>`
        ).join('')}</div>`
      : '';

    const overdueTag = a.is_overdue
      ? '<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-red-600 text-white ml-2">OVERDUE</span>'
      : '';

    const completeBadge = isComplete
      ? '<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-green-600 text-white ml-2">DONE</span>'
      : '';

    const slaTime = a.sla_deadline ? new Date(a.sla_deadline + 'Z').toLocaleTimeString() : '—';
    const titleDisplay = a.title ? escapeHtml(a.title) : '<span class="italic text-gray-400">No title</span>';
    const notesDisplay = a.notes ? `<p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${escapeHtml(a.notes)}</p>` : '';

    return `
      <div class="bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg px-5 py-4 ${a.is_overdue ? 'border-red-300 dark:border-red-700 bg-red-50 dark:bg-red-900/10' : ''}">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-xs text-gray-400 dark:text-gray-500 uppercase tracking-wide">${escapeHtml(getDisplayName(a))}</span>
              ${stateBadge(a.current_state, terminal)}
              ${priorityBadge(a.priority)}
              ${overdueTag}
              ${completeBadge}
            </div>
            <div class="mt-1 font-semibold text-gray-800 dark:text-gray-100">${titleDisplay}</div>
            ${notesDisplay}
          </div>
          <div class="flex items-center gap-2 ml-4 shrink-0">
            <button onclick="openEdit(${a.id}, '${encodeURIComponent(a.title || '')}', '${encodeURIComponent(a.notes || '')}', '${a.priority}')"
              class="text-xs text-gray-400 hover:text-blue-600 border border-gray-300 dark:border-gray-700 rounded px-2 py-1 hover:border-blue-300 transition" title="Edit">Edit</button>
            <div class="text-xs text-gray-400 dark:text-gray-500 text-right">
              <div>${escapeHtml(a.queue_department || a.department)}</div>
              <div>SLA ${slaTime}</div>
              <div>#${a.id}</div>
            </div>
          </div>
        </div>
        ${transitionUI}
      </div>`;
  }).join('');
}

function openDischargePanel() {
  document.getElementById('dischargePanel').classList.remove('hidden');
}

async function submitDischarge() {
  const notes = document.getElementById('dischargeNotes').value || '';
  const res = await fetch(`/patients/${PID}/discharge`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ notes }),
  });
  if (!res.ok) {
    let err = {};
    try { err = await res.json(); } catch {}
    showToast(err.detail || err.error || 'Failed to discharge patient', 'error');
    return;
  }
  showToast('Patient discharged', 'success');
  document.getElementById('dischargePanel').classList.add('hidden');
  document.getElementById('dischargeNotes').value = '';
  refresh();
}

async function loadSummary() {
  const res = await fetch(`/patients/${PID}/summary`);
  if (!res.ok) {
    document.getElementById('summary').innerHTML = '<p class="text-red-600 text-sm">Failed to load summary.</p>';
    document.getElementById('summaryText').textContent = '';
    return;
  }
  const s = await res.json();
  document.getElementById('summary').innerHTML = [
    ['Total', s.total_actions, 'bg-white dark:bg-gray-800'],
    ['Pending', s.pending, 'bg-white dark:bg-gray-800'],
    ['In Progress', s.in_progress, 'bg-blue-50 dark:bg-blue-900/20'],
    ['Completed', s.completed, 'bg-green-50 dark:bg-green-900/20'],
    ['Overdue', s.overdue, s.overdue > 0 ? 'bg-red-50 dark:bg-red-900/20' : 'bg-white dark:bg-gray-800'],
  ].map(([label, val, bg]) => `
    <div class="${bg} border dark:border-gray-700 rounded-lg px-4 py-3 text-center">
      <div class="text-2xl font-bold text-gray-800 dark:text-gray-100">${val}</div>
      <div class="text-xs text-gray-500 dark:text-gray-400">${label}</div>
    </div>
  `).join('');
  document.getElementById('summaryText').textContent = s.summary_text || '';
}

async function loadTimeline() {
  const res = await fetch(`/patients/${PID}/timeline`);
  if (!res.ok) {
    document.getElementById('timeline').innerHTML = '<p class="text-red-600 text-sm">Failed to load timeline.</p>';
    return;
  }
  const events = await res.json();
  const el = document.getElementById('timeline');
  if (events.length === 0) {
    el.innerHTML = '<p class="text-gray-400 text-sm">No events.</p>';
    return;
  }
  el.innerHTML = events.map(e => {
    const actorBits = [];
    if (e.actor_name) actorBits.push(escapeHtml(e.actor_name));
    if (e.actor_role) actorBits.push(escapeHtml(String(e.actor_role).toUpperCase()));
    if (e.actor_department) actorBits.push(escapeHtml(e.actor_department));
    const actorTag = actorBits.length > 0
      ? `<span class="text-xs text-indigo-600 dark:text-indigo-300">by ${actorBits.join(' • ')}</span>`
      : '<span class="text-xs text-gray-400">by system</span>';
    const deptTag = e.department
      ? `<span class="text-xs text-gray-500 dark:text-gray-400">(${escapeHtml(e.department)})</span>`
      : '';
    return `
    <div class="flex flex-wrap items-start gap-2 text-sm">
      <span class="text-xs text-gray-400 dark:text-gray-500 w-44 shrink-0 pt-0.5">${new Date(e.timestamp + 'Z').toLocaleString()}</span>
      <span class="text-gray-500 dark:text-gray-400 font-medium">${escapeHtml(e.action_name || ('Action #' + e.action_id))}</span>
      ${deptTag}
      <span class="text-gray-500 dark:text-gray-400">${escapeHtml(e.previous_state || '—')}</span>
      <span class="text-gray-400">&rarr;</span>
      <span class="font-medium text-gray-700 dark:text-gray-200">${escapeHtml(e.new_state)}</span>
      ${actorTag}
      ${e.notes ? `<span class="text-gray-400 italic">"${escapeHtml(e.notes)}"</span>` : ''}
    </div>`;
  }).join('');
}

function openEdit(id, titleEncoded, notesEncoded, priority) {
  editingActionId = id;
  document.getElementById('editId').textContent = '#' + id;
  document.getElementById('editTitle').value = decodeURIComponent(titleEncoded || '');
  document.getElementById('editNotes').value = decodeURIComponent(notesEncoded || '');
  document.getElementById('editPriority').value = priority;
  document.getElementById('editModal').classList.remove('hidden');
}

function closeEdit() {
  document.getElementById('editModal').classList.add('hidden');
  editingActionId = null;
}

async function saveEdit(e) {
  e.preventDefault();
  const res = await fetch(`/actions/${editingActionId}`, {
    method: 'PATCH',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      title: document.getElementById('editTitle').value,
      notes: document.getElementById('editNotes').value,
      priority: document.getElementById('editPriority').value,
    })
  });
  if (!res.ok) {
    let err = {};
    try { err = await res.json(); } catch {}
    showToast(err.detail || err.error || 'Failed to update action', 'error');
    return;
  }
  showToast('Action updated', 'success');
  closeEdit();
  refresh();
}

function openTransition(id, from, to) {
  pendingTransition = { id, from, to };
  document.getElementById('transId').textContent = '#' + id;
  document.getElementById('transLabel').textContent = `${from} → ${to}`;
  document.getElementById('transNotes').value = '';
  document.getElementById('transitionModal').classList.remove('hidden');
}

function closeTransition() {
  document.getElementById('transitionModal').classList.add('hidden');
  pendingTransition = null;
}

async function confirmTransition(e) {
  e.preventDefault();
  const notes = document.getElementById('transNotes').value;
  const res = await fetch(`/actions/${pendingTransition.id}/transition`, {
    method: 'PATCH',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ new_state: pendingTransition.to, notes })
  });
  if (!res.ok) {
    let err = {};
    try { err = await res.json(); } catch {}
    showToast(err.detail || err.error || 'Failed transition', 'error');
    return;
  }
  showToast('Transition saved', 'success');
  closeTransition();
  refresh();
}

async function createAction(e) {
  e.preventDefault();
  const typeVal = document.getElementById('aType').value;
  const priority = document.getElementById('aPriority').value;
  const title = document.getElementById('aTitle').value.trim();
  const departmentTarget = document.getElementById('aDeptTarget').value.trim();
  const notes = document.getElementById('aNotes').value;
  if (!title) {
    showToast('Action title is required', 'warning');
    return;
  }
  let body;
  if (typeVal.startsWith('custom:')) {
    body = { patient_id: PID, custom_action_type_id: parseInt(typeVal.split(':')[1], 10), priority, title, notes };
  } else {
    body = { patient_id: PID, action_type: typeVal, priority, title, notes, department_target: departmentTarget || null };
  }
  const res = await fetch('/actions', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    let err = {};
    try { err = await res.json(); } catch {}
    showToast(err.detail || err.error || 'Failed to create action', 'error');
    return;
  }
  const payload = await res.json();
  if (payload.warnings && payload.warnings.length) {
    renderInteractionWarnings(payload.warnings);
    showToast('Medication interaction warning generated', 'warning', 5000);
  } else {
    renderInteractionWarnings([]);
    showToast('Action created', 'success');
  }
  document.getElementById('aTitle').value = '';
  document.getElementById('aDeptTarget').value = '';
  document.getElementById('aNotes').value = '';
  document.getElementById('newActionForm').classList.add('hidden');
  refresh();
}

async function createCustomType(e) {
  e.preventDefault();
  const states = document.getElementById('ctStates').value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
  if (states.length < 2) {
    showToast('Need at least 2 states', 'warning');
    return;
  }
  const body = {
    name: document.getElementById('ctName').value.trim().toUpperCase().replace(/\s+/g, '_'),
    department: document.getElementById('ctDept').value.trim(),
    states,
    terminal_state: states[states.length - 1],
    sla_routine_minutes: parseInt(document.getElementById('ctSlaR').value, 10) || 120,
    sla_urgent_minutes: parseInt(document.getElementById('ctSlaU').value, 10) || 30,
    sla_critical_minutes: parseInt(document.getElementById('ctSlaC').value, 10) || 10,
  };
  const res = await fetch('/custom-action-types', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  if (res.ok) {
    document.getElementById('ctName').value = '';
    document.getElementById('ctDept').value = '';
    document.getElementById('ctStates').value = '';
    document.getElementById('customTypeForm').classList.add('hidden');
    await loadCustomTypes();
    showToast('Custom type created', 'success');
  } else {
    let err = {};
    try { err = await res.json(); } catch {}
    showToast(err.detail || 'Failed to create custom type', 'error');
  }
}

async function loadNotes() {
  const res = await fetch(`/patients/${PID}/notes`);
  const el = document.getElementById('notesList');
  if (!res.ok) {
    el.innerHTML = '<p class="text-red-600 text-sm">Failed to load notes.</p>';
    return;
  }
  const notes = await res.json();
  if (notes.length === 0) {
    el.innerHTML = '<p class="text-gray-400 text-sm">No clinical notes yet.</p>';
    return;
  }
  el.innerHTML = notes.map(n => `
    <div class="bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg px-4 py-3">
      <div class="flex items-center justify-between mb-1">
        <div class="flex items-center gap-2">
          <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200">${escapeHtml(n.note_type)}</span>
          <span class="text-xs text-indigo-600 dark:text-indigo-300">${escapeHtml(n.author_name || 'Unknown')}${n.author_role ? ' (' + escapeHtml(String(n.author_role).toUpperCase()) + ')' : ''}</span>
        </div>
        <span class="text-xs text-gray-400 dark:text-gray-500">${new Date(n.created_at + 'Z').toLocaleString()}</span>
      </div>
      <p class="text-sm text-gray-700 dark:text-gray-200 whitespace-pre-wrap">${escapeHtml(n.content)}</p>
    </div>
  `).join('');
}

async function createNote(e) {
  e.preventDefault();
  const content = document.getElementById('noteContent').value.trim();
  if (!content) {
    showToast('Note content is required', 'warning');
    return;
  }
  const res = await fetch(`/patients/${PID}/notes`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      note_type: document.getElementById('noteType').value,
      content,
    })
  });
  if (!res.ok) {
    let err = {};
    try { err = await res.json(); } catch {}
    showToast(err.detail || err.error || 'Failed to create note', 'error');
    return;
  }
  document.getElementById('noteContent').value = '';
  document.getElementById('noteForm').classList.add('hidden');
  showToast('Note added', 'success');
  loadNotes();
}

async function loadTransferStaff() {
  const res = await fetch('/patients/staff/doctors');
  if (!res.ok) return;
  const staff = await res.json();
  const select = document.getElementById('transferDoctor');
  select.querySelectorAll('option[data-dyn]').forEach((opt) => opt.remove());
  for (const user of staff) {
    const opt = document.createElement('option');
    opt.value = user.id;
    opt.textContent = `${user.name} (${String(user.role).toUpperCase()})`;
    opt.setAttribute('data-dyn', '1');
    select.appendChild(opt);
  }
}

function openTransferModal() {
  document.getElementById('transferModal').classList.remove('hidden');
}

function closeTransferModal() {
  document.getElementById('transferModal').classList.add('hidden');
}

async function submitTransfer(e) {
  e.preventDefault();
  const toDoctor = document.getElementById('transferDoctor').value;
  const toWard = document.getElementById('transferWard').value.trim();
  const reason = document.getElementById('transferReason').value.trim();
  const res = await fetch(`/patients/${PID}/transfer`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      to_doctor_id: toDoctor ? Number(toDoctor) : null,
      to_ward: toWard || null,
      reason,
    }),
  });
  if (!res.ok) {
    let err = {};
    try { err = await res.json(); } catch {}
    showToast(err.detail || err.error || 'Failed to transfer patient', 'error');
    return;
  }
  showToast('Patient transferred', 'success');
  document.getElementById('transferWard').value = '';
  document.getElementById('transferReason').value = '';
  document.getElementById('transferDoctor').value = '';
  closeTransferModal();
  loadTransfers();
  loadPatient();
}

async function loadTransfers() {
  const res = await fetch(`/patients/${PID}/transfers`);
  const el = document.getElementById('transferList');
  if (!res.ok) {
    el.innerHTML = '<p class="text-red-600 text-sm">Failed to load transfer history.</p>';
    return;
  }
  const rows = await res.json();
  if (!rows.length) {
    el.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No transfers yet.</p>';
    return;
  }
  el.innerHTML = rows.map((row) => `
    <div class="border dark:border-gray-700 rounded px-3 py-2 text-sm bg-gray-50 dark:bg-gray-900/20">
      <div class="text-gray-700 dark:text-gray-200 font-medium">${escapeHtml(row.from_ward || '—')} → ${escapeHtml(row.to_ward || '—')}</div>
      <div class="text-xs text-gray-500 dark:text-gray-400">${escapeHtml(row.from_doctor_name || 'Unassigned')} → ${escapeHtml(row.to_doctor_name || 'Unassigned')}</div>
      <div class="text-xs text-gray-500 dark:text-gray-400">${new Date(row.created_at + 'Z').toLocaleString()} by ${escapeHtml(row.transferred_by_name || 'Unknown')}</div>
      ${row.reason ? `<div class="text-xs text-gray-600 dark:text-gray-300 mt-1">${escapeHtml(row.reason)}</div>` : ''}
    </div>
  `).join('');
}

async function uploadAttachment(e) {
  e.preventDefault();
  const fileInput = document.getElementById('attachmentFile');
  const actionId = document.getElementById('attachmentActionId').value.trim();
  if (!fileInput.files || !fileInput.files[0]) {
    showToast('Select a file to upload', 'warning');
    return;
  }
  const formData = new FormData();
  formData.append('file', fileInput.files[0]);
  const query = actionId ? `?action_id=${encodeURIComponent(actionId)}` : '';
  const res = await fetch(`/patients/${PID}/files${query}`, {
    method: 'POST',
    body: formData,
  });
  if (!res.ok) {
    let err = {};
    try { err = await res.json(); } catch {}
    showToast(err.detail || err.error || 'Failed to upload file', 'error');
    return;
  }
  fileInput.value = '';
  document.getElementById('attachmentActionId').value = '';
  showToast('File uploaded', 'success');
  loadAttachments();
}

async function loadAttachments() {
  const res = await fetch(`/patients/${PID}/files`);
  const el = document.getElementById('attachmentList');
  if (!res.ok) {
    el.innerHTML = '<p class="text-red-600 text-sm">Failed to load files.</p>';
    return;
  }
  const files = await res.json();
  if (!files.length) {
    el.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No attachments yet.</p>';
    return;
  }
  el.innerHTML = files.map((file) => `
    <div class="border dark:border-gray-700 rounded px-3 py-2 text-sm bg-gray-50 dark:bg-gray-900/20 flex items-center justify-between gap-2">
      <div>
        <div class="font-medium text-gray-700 dark:text-gray-200">${escapeHtml(file.filename)}</div>
        <div class="text-xs text-gray-500 dark:text-gray-400">${Math.round((file.file_size || 0) / 1024)} KB · ${escapeHtml(file.uploader_name || 'Unknown')} · ${new Date(file.created_at + 'Z').toLocaleString()}</div>
      </div>
      <button onclick="downloadAttachment(${file.id}, '${encodeURIComponent(file.filename)}')" class="border border-gray-300 dark:border-gray-700 text-xs px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800">Download</button>
    </div>
  `).join('');
}

async function downloadAttachment(fileId, nameEncoded) {
  const res = await fetch(`/files/${fileId}`);
  if (!res.ok) {
    showToast('Failed to download file', 'error');
    return;
  }
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = decodeURIComponent(nameEncoded || 'attachment');
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

async function downloadPatientExport(format) {
  const res = await fetch(`/export/patients/${PID}/${format}`);
  if (!res.ok) {
    showToast(`Failed to export ${format.toUpperCase()}`, 'error');
    return;
  }
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = format === 'csv' ? `patient-${PID}-report.csv` : `patient-${PID}-report.html`;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
  showToast(`${format.toUpperCase()} export downloaded`, 'success');
}

function refresh() {
  loadPatient();
  loadSummary();
  loadNotes();
  loadTimeline();
  loadTransfers();
  loadAttachments();
}

const wsEl = document.getElementById('wsStatus');
let ws;

function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const token = getAuthToken() || '';
  ws = new WebSocket(`${proto}//${location.host}/ws/patients/${PID}?token=${encodeURIComponent(token)}`);
  ws.onopen = () => {
    wsEl.textContent = 'Live';
    wsEl.className = 'fixed bottom-4 right-4 text-xs px-3 py-1.5 rounded-full bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-200';
  };
  ws.onmessage = (event) => {
    try {
      const payload = JSON.parse(event.data);
      handleRealtimeEvent(payload);
    } catch {
      // ignore parse failures
    }
    refresh();
  };
  ws.onclose = () => {
    wsEl.textContent = 'Reconnecting...';
    wsEl.className = 'fixed bottom-4 right-4 text-xs px-3 py-1.5 rounded-full bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-200';
    setTimeout(connectWS, 2000);
  };
}

window.clavisToggleNewForm = () => togglePanel('newActionForm');

loadCustomTypes().then(async () => {
  if (!canManagePatient()) {
    document.getElementById('btnCustomType')?.classList.add('hidden');
    document.getElementById('btnNewAction')?.classList.add('hidden');
    document.getElementById('customTypeForm')?.classList.add('hidden');
    document.getElementById('newActionForm')?.classList.add('hidden');
  }
  await loadTransferStaff();
  connectWS();
  refresh();
});
</script>
{% endblock %}
