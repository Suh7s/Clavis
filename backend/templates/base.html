<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-100 dark:bg-slate-950">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Clavis{% endblock %}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,500;9..144,700&family=Sora:wght@400;500;600;700&family=Syne:wght@500;700;800&display=swap" rel="stylesheet" />
  <script>
    (function() {
      try {
        const key = 'clavis_theme';
        const saved = localStorage.getItem(key);
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = (saved === 'dark' || saved === 'light') ? saved : (prefersDark ? 'dark' : 'light');
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        }
      } catch (_err) {}
    })();
  </script>
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      darkMode: 'class',
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    window.addEventListener('load', function() {
      if (!window.tailwind) return;
      window.tailwind.config = {
        ...(window.tailwind.config || {}),
        darkMode: 'class',
      };
      if (typeof window.tailwind.refresh === 'function') {
        window.tailwind.refresh();
      }
    });
  </script>
  <style>
    :root {
      --font-body: "Sora", "Avenir Next", "Segoe UI", sans-serif;
      --font-display: "Syne", "Fraunces", "Iowan Old Style", "Times New Roman", serif;

      --bg: #edf4f2;
      --bg-alt: #f7fbfa;
      --ink: #123138;
      --ink-soft: #47646c;
      --ink-faint: #6a858d;
      --line: rgba(18, 49, 56, 0.14);

      --surface: rgba(255, 255, 255, 0.82);
      --surface-soft: rgba(248, 252, 251, 0.74);
      --surface-strong: rgba(255, 255, 255, 0.94);

      --brand: #0f766e;
      --brand-strong: #0a5f58;
      --brand-soft: #d8f3ef;
      --brand-line: rgba(15, 118, 110, 0.3);

      --accent: #f27f3d;
      --accent-soft: #ffe8d8;
      --accent-line: rgba(242, 127, 61, 0.28);

      --success: #0f766e;
      --danger: #be3d2f;
      --warning: #bd7a2a;

      --ambient-one: rgba(15, 118, 110, 0.18);
      --ambient-two: rgba(242, 127, 61, 0.16);
      --ambient-three: rgba(26, 86, 219, 0.09);
      --ambient-four: rgba(124, 58, 237, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.44);
    }

    html.dark {
      --bg: #06151b;
      --bg-alt: #0b1f27;
      --ink: #e8f2f3;
      --ink-soft: #b1c7cb;
      --ink-faint: #7f9aa0;
      --line: rgba(193, 226, 234, 0.2);

      --surface: rgba(11, 31, 39, 0.72);
      --surface-soft: rgba(8, 23, 30, 0.74);
      --surface-strong: rgba(13, 35, 44, 0.86);

      --brand: #1fa195;
      --brand-strong: #16796f;
      --brand-soft: rgba(31, 161, 149, 0.2);
      --brand-line: rgba(66, 202, 188, 0.38);

      --accent: #ff9a56;
      --accent-soft: rgba(255, 154, 86, 0.2);
      --accent-line: rgba(255, 166, 113, 0.34);

      --success: #36c7a8;
      --danger: #ee7f74;
      --warning: #ffbe63;

      --ambient-one: rgba(31, 161, 149, 0.17);
      --ambient-two: rgba(255, 154, 86, 0.14);
      --ambient-three: rgba(87, 139, 252, 0.14);
      --ambient-four: rgba(167, 139, 250, 0.12);
      --glass-highlight: rgba(255, 255, 255, 0.22);
    }

    html {
      color-scheme: light;
      background: var(--bg);
    }

    html.dark {
      color-scheme: dark;
    }

    body {
      position: relative;
      overflow-x: hidden;
      font-family: var(--font-body);
      color: var(--ink);
      background:
        radial-gradient(1200px 540px at -8% -12%, var(--ambient-one), transparent 62%),
        radial-gradient(980px 500px at 103% -7%, var(--ambient-two), transparent 56%),
        radial-gradient(700px 390px at 54% 105%, var(--ambient-three), transparent 68%),
        radial-gradient(560px 300px at 52% 8%, var(--ambient-four), transparent 72%),
        linear-gradient(160deg, var(--bg), var(--bg-alt));
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      pointer-events: none;
      z-index: -1;
      border-radius: 9999px;
      filter: blur(56px);
      animation: ambientFloat 18s ease-in-out infinite;
    }

    body::before {
      width: 28rem;
      height: 28rem;
      top: -8rem;
      right: -8rem;
      background: var(--ambient-one);
    }

    body::after {
      width: 22rem;
      height: 22rem;
      bottom: -7rem;
      left: -5rem;
      background: var(--ambient-two);
      animation-delay: -7s;
    }

    body::selection,
    body *::selection {
      background: rgba(35, 193, 176, 0.34);
      color: #042124;
    }

    .clavis-atmosphere {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -3;
      overflow: hidden;
    }

    .clavis-atmosphere .ring {
      position: absolute;
      border-radius: 9999px;
      border: 1px solid rgba(255, 255, 255, 0.34);
      opacity: 0.32;
      mix-blend-mode: screen;
      animation: drift 26s linear infinite;
    }

    .clavis-atmosphere .ring.ring-a {
      width: 34rem;
      height: 34rem;
      top: -12rem;
      left: -8rem;
      border-color: rgba(62, 210, 189, 0.36);
    }

    .clavis-atmosphere .ring.ring-b {
      width: 26rem;
      height: 26rem;
      bottom: -8rem;
      right: -6rem;
      border-color: rgba(255, 182, 123, 0.34);
      animation-direction: reverse;
      animation-duration: 30s;
    }

    .clavis-atmosphere .ring.ring-c {
      width: 18rem;
      height: 18rem;
      top: 42%;
      left: 72%;
      border-color: rgba(118, 158, 255, 0.28);
      animation-duration: 33s;
    }

    h1,
    h2,
    h3,
    .display-font {
      font-family: var(--font-display);
      letter-spacing: -0.014em;
    }

    main {
      position: relative;
      z-index: 1;
    }

    main section,
    main article {
      animation: revealUp 520ms cubic-bezier(.2,.7,.2,1) both;
    }

    main section:nth-of-type(2),
    main article:nth-of-type(2) {
      animation-delay: 60ms;
    }

    main section:nth-of-type(3),
    main article:nth-of-type(3) {
      animation-delay: 110ms;
    }

    main {
      isolation: isolate;
    }

    main::before {
      content: "";
      position: absolute;
      inset: -1rem -1rem auto -1rem;
      height: 20rem;
      pointer-events: none;
      z-index: -1;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.24), transparent 60%),
        radial-gradient(740px 260px at 50% 0, rgba(15,118,110,0.16), transparent 72%);
      opacity: 0.92;
      mask-image: linear-gradient(180deg, black, transparent 82%);
    }

    .bg-white,
    .bg-slate-50,
    .bg-slate-100,
    .bg-slate-200,
    .dark\:bg-gray-800,
    .dark\:bg-gray-700 {
      background-color: var(--surface) !important;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .bg-slate-50 {
      background-color: var(--surface-soft) !important;
    }

    .bg-slate-100,
    .bg-slate-200 {
      background-color: var(--surface-strong) !important;
    }

    .border-slate-200,
    .border-slate-100,
    .border-gray-300,
    .border-gray-200,
    .dark\:border-gray-700,
    .dark\:border-gray-600 {
      border-color: var(--line) !important;
    }

    .text-slate-900,
    .text-slate-800,
    .text-slate-700,
    .text-gray-900,
    .text-gray-800,
    .dark\:text-gray-100,
    .dark\:text-gray-200 {
      color: var(--ink) !important;
    }

    .text-slate-600,
    .text-slate-500,
    .text-gray-600,
    .text-gray-500,
    .dark\:text-gray-300,
    .dark\:text-gray-400 {
      color: var(--ink-soft) !important;
    }

    .text-slate-400,
    .text-gray-400 {
      color: var(--ink-faint) !important;
    }

    .bg-indigo-600,
    .bg-indigo-500,
    .bg-blue-600,
    .bg-blue-500 {
      background: linear-gradient(130deg, var(--brand), var(--brand-strong)) !important;
      color: #f8fffe !important;
      box-shadow: 0 16px 34px -18px rgba(15, 118, 110, 0.9);
    }

    .hover\:bg-indigo-700:hover,
    .hover\:bg-blue-700:hover {
      filter: brightness(0.96);
    }

    .bg-indigo-50,
    .bg-blue-50 {
      background-color: var(--brand-soft) !important;
    }

    .text-indigo-700,
    .text-indigo-800,
    .text-blue-700,
    .text-blue-800,
    .dark\:text-indigo-200 {
      color: var(--brand-strong) !important;
    }

    .border-indigo-200,
    .border-indigo-300,
    .border-blue-200 {
      border-color: var(--brand-line) !important;
    }

    .bg-emerald-50 {
      background-color: rgba(35, 178, 137, 0.16) !important;
    }

    .text-emerald-700 {
      color: var(--success) !important;
    }

    .bg-rose-50 {
      background-color: rgba(219, 86, 72, 0.13) !important;
    }

    .text-rose-700 {
      color: var(--danger) !important;
    }

    .bg-amber-50 {
      background-color: rgba(230, 156, 74, 0.17) !important;
    }

    .text-amber-700 {
      color: var(--warning) !important;
    }

    .hover\:bg-slate-50:hover,
    .hover\:bg-slate-100:hover,
    .dark\:hover\:bg-gray-800:hover {
      background-color: rgba(148, 189, 187, 0.18) !important;
    }

    .shadow-xl,
    .shadow-lg,
    .shadow-sm {
      box-shadow: 0 16px 45px -34px rgba(6, 34, 43, 0.55) !important;
    }

    .rounded-2xl.border,
    .rounded-xl.border {
      box-shadow:
        0 22px 45px -38px rgba(6, 34, 43, 0.75),
        0 1px 0 0 var(--glass-highlight) inset !important;
    }

    .rounded-2xl {
      border-radius: 1.2rem;
    }

    .rounded-xl {
      border-radius: 0.9rem;
    }

    input,
    select,
    textarea {
      transition: border-color 170ms ease, box-shadow 170ms ease, background-color 170ms ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--brand-line) !important;
      box-shadow: 0 0 0 4px rgba(31, 161, 149, 0.12) !important;
    }

    button,
    a {
      transition: transform 170ms ease, box-shadow 170ms ease, background-color 170ms ease, color 170ms ease;
    }

    button:hover,
    a:hover {
      transform: translateY(-1px);
    }

    button:active,
    a:active {
      transform: translateY(0);
    }

    #sidebarBackdrop {
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    body.public-route #sidenav,
    body.public-route #sidebarBackdrop,
    body.public-route header {
      display: none !important;
    }

    body.public-route .lg\:pl-72 {
      padding-left: 0 !important;
    }

    body.public-route main {
      max-width: 62rem;
      margin: 0 auto;
      padding-top: 3.5rem;
    }

    body.public-route main::before {
      content: "";
      position: absolute;
      inset: -2rem -2rem auto -2rem;
      height: 16rem;
      background:
        radial-gradient(600px 280px at 20% 20%, var(--ambient-one), transparent 72%),
        radial-gradient(500px 240px at 80% 30%, var(--ambient-two), transparent 74%);
      pointer-events: none;
      z-index: -1;
      opacity: 0.9;
    }

    main::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -2;
      opacity: 0.24;
      background-image:
        linear-gradient(rgba(255,255,255,0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px);
      background-size: 34px 34px;
      mask-image: radial-gradient(circle at 50% 30%, black, transparent 72%);
    }

    .rounded-2xl.border,
    .rounded-xl.border,
    section.rounded-2xl,
    article.rounded-2xl {
      position: relative;
      overflow: hidden;
    }

    section.rounded-2xl::before,
    article.rounded-2xl::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      border-radius: inherit;
      border: 1px solid transparent;
      background: linear-gradient(145deg, rgba(255,255,255,0.34), rgba(255,255,255,0) 36%) border-box;
      -webkit-mask:
        linear-gradient(#fff 0 0) padding-box,
        linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0.45;
    }

    #sidenav {
      background:
        linear-gradient(180deg, rgba(255,255,255,0.84), rgba(247,252,251,0.82)),
        radial-gradient(340px 180px at 50% 0, rgba(15,118,110,0.13), transparent 74%);
      border-right: 1px solid var(--line);
    }

    html.dark #sidenav {
      background:
        linear-gradient(180deg, rgba(10,28,35,0.9), rgba(8,23,30,0.86)),
        radial-gradient(320px 170px at 50% 0, rgba(31,161,149,0.24), transparent 72%);
    }

    #sidenav nav a {
      position: relative;
      isolation: isolate;
      overflow: hidden;
    }

    #sidenav nav a::before {
      content: "";
      position: absolute;
      inset: 0;
      z-index: -1;
      opacity: 0;
      transform: scaleX(0.86);
      transition: opacity 220ms ease, transform 220ms ease;
      background: linear-gradient(120deg, rgba(15,118,110,0.14), rgba(242,127,61,0.08));
      border-radius: inherit;
    }

    #sidenav nav a:hover::before,
    #sidenav nav a:focus-visible::before {
      opacity: 1;
      transform: scaleX(1);
    }

    #sidenav nav a.bg-indigo-600::before {
      opacity: 1;
      transform: scaleX(1);
      background: linear-gradient(120deg, rgba(255,255,255,0.16), rgba(255,255,255,0.04));
    }

    header {
      position: relative;
    }

    header::after {
      content: "";
      position: absolute;
      left: 1.5rem;
      right: 1.5rem;
      bottom: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(15,118,110,0.35), rgba(242,127,61,0.35), transparent);
      pointer-events: none;
    }

    #globalSearchInput {
      background: var(--surface-strong) !important;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2);
    }

    #globalSearchInput::placeholder {
      letter-spacing: 0.01em;
    }

    #themeToggleButton {
      background: linear-gradient(130deg, rgba(255,255,255,0.88), rgba(243,250,248,0.9)) !important;
      border-color: var(--line) !important;
    }

    html.dark #themeToggleButton {
      background: linear-gradient(130deg, rgba(11,32,39,0.92), rgba(14,39,48,0.88)) !important;
    }

    table thead th {
      letter-spacing: 0.12em;
    }

    table tbody tr {
      transition: background-color 180ms ease, transform 180ms ease;
    }

    table tbody tr:hover {
      transform: translateY(-1px);
    }

    ::selection {
      background: rgba(15,118,110,0.32);
      color: #062127;
    }

    html.dark ::selection {
      background: rgba(78,211,196,0.34);
      color: #e7fffb;
    }

    code {
      border: 1px solid var(--line);
      background: var(--surface-soft);
      border-radius: 0.55rem;
      padding: 0.08rem 0.35rem;
      font-size: 0.76em;
    }

    .bg-gradient-to-r.from-indigo-600.to-indigo-500,
    .bg-gradient-to-br.from-indigo-600.to-teal-700 {
      position: relative;
      overflow: hidden;
    }

    .bg-gradient-to-r.from-indigo-600.to-indigo-500::after,
    .bg-gradient-to-br.from-indigo-600.to-teal-700::after {
      content: "";
      position: absolute;
      inset: -34% 18% auto;
      height: 10rem;
      transform: rotate(-12deg);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.28), transparent);
      animation: sheen 9s ease-in-out infinite;
      pointer-events: none;
    }

    @media (prefers-reduced-motion: reduce) {
      main section,
      main article,
      body::before,
      body::after {
        animation: none !important;
      }

      button,
      a,
      table tbody tr {
        transition: none !important;
      }

      .bg-gradient-to-r.from-indigo-600.to-indigo-500::after,
      .bg-gradient-to-br.from-indigo-600.to-teal-700::after,
      .clavis-atmosphere .ring {
        animation: none !important;
      }
    }

    @keyframes revealUp {
      from {
        opacity: 0;
        transform: translateY(16px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes ambientFloat {
      0%, 100% {
        transform: translate3d(0, 0, 0) scale(1);
      }
      50% {
        transform: translate3d(0, -16px, 0) scale(1.03);
      }
    }

    @keyframes sheen {
      0%, 12% {
        transform: translateX(-24%) rotate(-12deg);
        opacity: 0;
      }
      24%, 44% {
        transform: translateX(18%) rotate(-12deg);
        opacity: 0.72;
      }
      60%, 100% {
        transform: translateX(64%) rotate(-12deg);
        opacity: 0;
      }
    }

    @keyframes drift {
      0% {
        transform: translate3d(0, 0, 0) rotate(0deg);
      }
      50% {
        transform: translate3d(0, -14px, 0) rotate(180deg);
      }
      100% {
        transform: translate3d(0, 0, 0) rotate(360deg);
      }
    }
  </style>
</head>
<body class="h-full bg-slate-100 text-slate-800 antialiased dark:bg-slate-950 dark:text-slate-100">
  <div class="clavis-atmosphere" aria-hidden="true">
    <span class="ring ring-a"></span>
    <span class="ring ring-b"></span>
    <span class="ring ring-c"></span>
  </div>
  <div class="min-h-screen">
    <div id="sidebarBackdrop" class="fixed inset-0 z-30 hidden bg-slate-900/40 lg:hidden" onclick="closeSidebar()"></div>

    <aside id="sidenav" class="fixed inset-y-0 left-0 z-40 w-72 -translate-x-full transform transition duration-300 ease-out lg:translate-x-0">
      {% include "components/sidenav.html" %}
    </aside>

    <div class="min-h-screen lg:pl-72">
      {% include "components/navbar.html" %}

      <main class="px-4 pb-8 pt-5 sm:px-6 lg:px-8 lg:pt-6">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  {% include "components/toast.html" %}

  <script>
    const sidebarEl = document.getElementById('sidenav');
    const sidebarBackdropEl = document.getElementById('sidebarBackdrop');
    const userMenuEl = document.getElementById('userMenu');
    const THEME_STORAGE_KEY = 'clavis_theme';

    function openSidebar() {
      if (!sidebarEl || !sidebarBackdropEl) return;
      sidebarEl.classList.remove('-translate-x-full');
      sidebarBackdropEl.classList.remove('hidden');
    }

    function closeSidebar() {
      if (!sidebarEl || !sidebarBackdropEl) return;
      sidebarEl.classList.add('-translate-x-full');
      sidebarBackdropEl.classList.add('hidden');
    }

    function toggleUserMenu() {
      if (!userMenuEl) return;
      userMenuEl.classList.toggle('hidden');
    }

    function getStoredTheme() {
      try {
        const saved = localStorage.getItem(THEME_STORAGE_KEY);
        if (saved === 'dark' || saved === 'light') return saved;
      } catch (_err) {}
      return '';
    }

    function systemTheme() {
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
        ? 'dark'
        : 'light';
    }

    function setTheme(theme) {
      const isDark = theme === 'dark';
      document.documentElement.classList.toggle('dark', isDark);
      try {
        localStorage.setItem(THEME_STORAGE_KEY, isDark ? 'dark' : 'light');
      } catch (_err) {}
      updateThemeToggle();
    }

    function toggleDarkMode() {
      const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
      setTheme(next);
      if (typeof showToast === 'function') {
        showToast(next === 'dark' ? 'Dark mode enabled' : 'Light mode enabled', 'info', 1400);
      }
    }

    function updateThemeToggle() {
      const button = document.getElementById('themeToggleButton');
      if (!button) return;
      const dark = document.documentElement.classList.contains('dark');
      button.textContent = dark ? 'Light' : 'Dark';
      button.setAttribute('aria-label', dark ? 'Switch to light mode' : 'Switch to dark mode');
    }

    function getAuthToken() {
      return sessionStorage.getItem('clavis_token');
    }

    function getCurrentUser() {
      const raw = sessionStorage.getItem('clavis_user');
      if (!raw) return null;
      try {
        return JSON.parse(raw);
      } catch (_err) {
        return null;
      }
    }

    function clearAuthSession() {
      sessionStorage.removeItem('clavis_token');
      sessionStorage.removeItem('clavis_user');
    }

    function setAuthSession(token, user) {
      sessionStorage.setItem('clavis_token', token);
      sessionStorage.setItem('clavis_user', JSON.stringify(user || {}));
    }

    function homeForRole(role) {
      const map = {
        doctor: '/dashboard/view',
        admin: '/dashboard/view',
        nurse: '/departments/Nursing/view',
        pharmacist: '/departments/Pharmacy/view',
        lab_tech: '/departments/Laboratory/view',
        radiologist: '/departments/Radiology/view'
      };
      return map[String(role || '').toLowerCase()] || '/dashboard/view';
    }

    function getDepartmentForRole(user) {
      if (!user || !user.role) return 'Emergency';
      const roleToDept = {
        nurse: 'Nursing',
        pharmacist: 'Pharmacy',
        lab_tech: 'Laboratory',
        radiologist: 'Radiology',
        doctor: 'Emergency',
        admin: 'Emergency'
      };
      return roleToDept[String(user.role).toLowerCase()] || (user.department || 'Emergency');
    }

    function isPublicPath(pathname) {
      return pathname === '/login';
    }

    function shouldAttachAuth(urlPath) {
      return !urlPath.startsWith('/auth/login') && !urlPath.startsWith('/api/v1/auth/login') && !urlPath.startsWith('/health');
    }

    function logout() {
      clearAuthSession();
      location.href = '/login';
    }

    function isTextInputTarget(target) {
      if (!(target instanceof Element)) return false;
      const tag = target.tagName.toLowerCase();
      return target.isContentEditable || tag === 'input' || tag === 'textarea' || tag === 'select';
    }

    function focusSearchTarget() {
      const target = window.clavisSearchTarget
        || document.getElementById('globalSearchInput')
        || document.querySelector('[data-shortcut-search]');
      if (!target || typeof target.focus !== 'function') return false;
      target.focus();
      if (typeof target.select === 'function') target.select();
      return true;
    }

    function bindKeyboardShortcuts() {
      document.addEventListener('keydown', function(event) {
        const key = String(event.key || '').toLowerCase();

        if ((event.metaKey || event.ctrlKey) && key === 'k') {
          event.preventDefault();
          focusSearchTarget();
          return;
        }

        if ((event.metaKey || event.ctrlKey) && event.shiftKey && key === 'd') {
          event.preventDefault();
          toggleDarkMode();
          return;
        }

        if (event.altKey && key === 'n') {
          if (isTextInputTarget(event.target)) return;
          if (typeof window.clavisToggleNewForm === 'function') {
            event.preventDefault();
            window.clavisToggleNewForm();
          }
          return;
        }

        if (!event.metaKey && !event.ctrlKey && !event.altKey && key === '?') {
          if (typeof showToast === 'function') {
            showToast('Shortcuts: Ctrl/Cmd+K search, Alt+N new form, Ctrl/Cmd+Shift+D theme', 'info', 5000);
          }
        }
      });
    }

    function renderAuthUI() {
      const user = getCurrentUser();
      const navUserName = document.getElementById('navUserName');
      const navUserInitials = document.getElementById('navUserInitials');
      const departmentQueueLink = document.getElementById('departmentQueueLink');
      const privilegedLinks = document.querySelectorAll('.privileged-link');

      if (user && navUserName) {
        navUserName.textContent = user.name || 'Care Coordinator';
      }
      if (navUserInitials) {
        const initials = user && user.name
          ? user.name.split(/\s+/).filter(Boolean).slice(0, 2).map((chunk) => chunk[0]).join('').toUpperCase()
          : 'CL';
        navUserInitials.textContent = initials || 'CL';
      }

      if (departmentQueueLink) {
        const dept = getDepartmentForRole(user);
        departmentQueueLink.href = '/departments/' + encodeURIComponent(dept) + '/view';
      }

      const privileged = user && ['doctor', 'admin'].includes(String(user.role || '').toLowerCase());
      privilegedLinks.forEach((link) => {
        link.classList.toggle('hidden', !privileged);
      });
    }

    const __nativeFetch = window.fetch.bind(window);
    window.fetch = async function(input, init = {}) {
      const merged = { cache: 'no-store', ...init };
      const token = getAuthToken();
      let url = '';

      if (typeof input === 'string') {
        url = input;
      } else if (input && typeof input.url === 'string') {
        url = input.url;
      }

      const path = url.startsWith(window.location.origin) ? url.slice(window.location.origin.length) : url;
      const isSameOrigin = !url || url.startsWith('/') || url.startsWith(window.location.origin);
      if (token && isSameOrigin && shouldAttachAuth(path || '')) {
        const headers = new Headers(merged.headers || {});
        if (!headers.has('Authorization')) {
          headers.set('Authorization', 'Bearer ' + token);
        }
        merged.headers = headers;
      }

      const response = await __nativeFetch(input, merged);
      if (response.status === 401 && !isPublicPath(window.location.pathname)) {
        clearAuthSession();
        location.href = '/login';
      }
      return response;
    };

    document.addEventListener('click', function(event) {
      const menuButton = document.getElementById('userMenuButton');
      if (!menuButton || !userMenuEl) return;
      if (!menuButton.contains(event.target) && !userMenuEl.contains(event.target)) {
        userMenuEl.classList.add('hidden');
      }
    });

    window.addEventListener('resize', function() {
      if (window.innerWidth >= 1024) {
        if (sidebarBackdropEl) sidebarBackdropEl.classList.add('hidden');
        if (sidebarEl) sidebarEl.classList.remove('-translate-x-full');
      } else if (sidebarEl) {
        sidebarEl.classList.add('-translate-x-full');
      }
    });

    window.addEventListener('DOMContentLoaded', function() {
      const initialTheme = getStoredTheme() || systemTheme();
      setTheme(initialTheme);
      if (isPublicPath(window.location.pathname)) {
        document.body.classList.add('public-route');
      }
      renderAuthUI();
      bindKeyboardShortcuts();
      if (!isPublicPath(window.location.pathname) && !getAuthToken()) {
        location.href = '/login';
      }
    });

    window.getAuthToken = getAuthToken;
    window.getCurrentUser = getCurrentUser;
    window.clearAuthSession = clearAuthSession;
    window.setAuthSession = setAuthSession;
    window.homeForRole = homeForRole;
    window.logout = logout;
    window.renderAuthUI = renderAuthUI;
    window.toggleDarkMode = toggleDarkMode;
    window.focusSearchTarget = focusSearchTarget;
  </script>

  {% block page_scripts %}{% endblock %}
</body>
</html>
