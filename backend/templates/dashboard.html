{% extends "base.html" %}
{% set page_title = "Dashboard" %}
{% set active_page = "dashboard" %}
{% block title %}Clavis | Dashboard{% endblock %}

{% block content %}
<div class="space-y-6">
  <section class="clavis-page-hero clavis-hero-section rounded-2xl border border-slate-200 p-6 text-white shadow-lg">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.16em] text-indigo-100">Operational Command Center</p>
        <h2 class="mt-1 text-2xl font-semibold">Realtime Clinical Workflow Dashboard</h2>
        <p class="mt-1 text-sm text-indigo-100">Live overview of patient throughput, queue pressure, and SLA risk across departments.</p>
      </div>
      <a href="/status-board/view" class="inline-flex items-center rounded-xl bg-white px-4 py-2 text-sm font-semibold text-indigo-700 hover:bg-indigo-50">Open Status Board</a>
    </div>
  </section>

  <section id="dashboardKpiGrid" class="clavis-kpi-grid grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <article class="clavis-tilt clavis-glow-border rounded-2xl border border-slate-200 bg-white p-5 shadow-sm" style="animation-delay: 60ms">
      <div class="clavis-shine" aria-hidden="true"></div>
      <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">Total Patients</p>
      <p id="metricTotalPatients" class="mt-4 text-3xl font-semibold text-slate-900">0</p>
      <p id="metricTotalPatientsSub" class="mt-2 text-sm text-slate-500">Active patient records</p>
    </article>

    <article class="clavis-tilt clavis-glow-border rounded-2xl border border-indigo-200 bg-indigo-50 p-5 shadow-sm" style="animation-delay: 120ms">
      <div class="clavis-shine" aria-hidden="true"></div>
      <p class="text-xs font-semibold uppercase tracking-[0.14em] text-indigo-700">Active Tasks</p>
      <p id="metricActiveTasks" class="mt-4 text-3xl font-semibold text-indigo-950">0</p>
      <p id="metricActiveTasksSub" class="mt-2 text-sm text-indigo-700/80">Current in-flight actions</p>
    </article>

    <article class="clavis-tilt clavis-glow-border rounded-2xl border border-rose-200 bg-rose-50 p-5 shadow-sm" style="animation-delay: 180ms">
      <div class="clavis-shine" aria-hidden="true"></div>
      <p class="text-xs font-semibold uppercase tracking-[0.14em] text-rose-700">Overdue Tasks</p>
      <p id="metricOverdueTasks" class="mt-4 text-3xl font-semibold text-rose-950">0</p>
      <p id="metricOverdueTasksSub" class="mt-2 text-sm text-rose-700/80">Escalation risk queue</p>
    </article>

    <article class="clavis-tilt clavis-glow-border rounded-2xl border border-emerald-200 bg-emerald-50 p-5 shadow-sm" style="animation-delay: 240ms">
      <div class="clavis-shine" aria-hidden="true"></div>
      <p class="text-xs font-semibold uppercase tracking-[0.14em] text-emerald-700">SLA Compliance</p>
      <p id="metricSlaCompliance" class="mt-4 text-3xl font-semibold text-emerald-950">--</p>
      <p id="metricSlaComplianceSub" class="mt-2 text-sm text-emerald-700/80">Rolling completion quality</p>
    </article>
  </section>

  <section class="grid gap-6 lg:grid-cols-3">
    <article class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
      <div class="flex items-center justify-between gap-3">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-400">Throughput</p>
          <h3 class="text-lg font-semibold text-slate-800">Department Throughput (24h)</h3>
        </div>
        <button id="refreshDashboardButton" type="button" class="rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-50">Refresh</button>
      </div>
      <div id="throughputBars" class="mt-5 space-y-3"></div>
    </article>

    <article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
      <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-400">Case Mix</p>
      <h3 class="text-lg font-semibold text-slate-800">Queue Distribution</h3>
      <div id="departmentMixList" class="mt-5 space-y-3"></div>
    </article>
  </section>

  <section class="grid gap-6 lg:grid-cols-3">
    <article class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
      <div class="flex items-center justify-between gap-3">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-400">Recent Activity</p>
          <h3 class="text-lg font-semibold text-slate-800">Latest Audit Events</h3>
        </div>
        <a href="/audit-log/view" class="rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-50">Open Audit Log</a>
      </div>
      <div id="recentActivityList" class="mt-5 space-y-3"></div>
    </article>

    <article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
      <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-400">Priority Watchlist</p>
      <h3 class="text-lg font-semibold text-slate-800">Current Risk Summary</h3>
      <div class="mt-5 space-y-3">
        <div class="rounded-xl border border-rose-200 bg-rose-50 p-3">
          <p id="watchCritical" class="text-sm font-semibold text-rose-700">0 critical escalations</p>
          <p class="mt-1 text-xs text-rose-600">SLA breaches requiring immediate action.</p>
        </div>
        <div class="rounded-xl border border-amber-200 bg-amber-50 p-3">
          <p id="watchUrgent" class="text-sm font-semibold text-amber-700">0 urgent actions</p>
          <p class="mt-1 text-xs text-amber-600">Urgent tasks still in queue.</p>
        </div>
        <div class="rounded-xl border border-indigo-200 bg-indigo-50 p-3">
          <p id="watchReferrals" class="text-sm font-semibold text-indigo-700">0 referral actions</p>
          <p class="mt-1 text-xs text-indigo-600">Cross-department handoffs in progress.</p>
        </div>
      </div>
      <a href="/departments/Emergency/view" class="mt-5 inline-flex w-full items-center justify-center rounded-xl bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-indigo-700">Open Emergency Queue</a>
    </article>
  </section>
</div>
{% endblock %}

{% block page_scripts %}
<script>
  function fmtNumber(value) {
    const num = Number(value || 0);
    return Number.isFinite(num) ? num.toLocaleString() : '0';
  }

  function formatRelative(iso) {
    if (!iso) return 'Unknown';
    const ts = new Date(iso.endsWith('Z') ? iso : iso + 'Z').getTime();
    if (!Number.isFinite(ts)) return iso;
    const delta = Math.max(0, Date.now() - ts);
    const minutes = Math.floor(delta / 60000);
    if (minutes < 1) return 'just now';
    if (minutes < 60) return minutes + 'm ago';
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + 'h ago';
    const days = Math.floor(hours / 24);
    return days + 'd ago';
  }

  function safeFetch(url) {
    return fetch(url).then(async (response) => {
      if (response.status === 403) {
        return { __forbidden: true, __status: 403 };
      }
      if (!response.ok) {
        const text = await response.text();
        throw new Error('Request failed for ' + url + ' (' + response.status + '): ' + text);
      }
      return response.json();
    });
  }

  async function fetchAllPatients() {
    const pageSize = 100;
    let page = 1;
    let all = [];
    let total = 0;

    while (true) {
      const response = await fetch('/patients?page=' + page + '&page_size=' + pageSize);
      if (!response.ok) {
        const detail = await response.text();
        throw new Error('Patients fetch failed (' + response.status + '): ' + detail);
      }
      const payload = await response.json();
      const rows = Array.isArray(payload.patients) ? payload.patients : [];
      all = all.concat(rows);
      total = Number(payload.total || all.length);
      if (!rows.length || all.length >= total) break;
      page += 1;
    }

    return all;
  }

  function renderThroughput(rows) {
    const host = document.getElementById('throughputBars');
    if (!host) return;

    if (!rows || !rows.length) {
      host.innerHTML = '<p class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-6 text-center text-sm text-slate-500">No throughput data available for this role.</p>';
      return;
    }

    const max24 = Math.max(...rows.map((row) => Number(row.last_24h || 0)), 1);
    host.innerHTML = rows.map((row) => {
      const value = Number(row.last_24h || 0);
      const percent = Math.max(6, Math.round((value / max24) * 100));
      return `
        <div class="space-y-1">
          <div class="flex items-center justify-between text-sm">
            <span class="font-medium text-slate-700">${row.department}</span>
            <span class="text-slate-500">${value} completed</span>
          </div>
          <div class="h-2.5 rounded-full bg-slate-100">
            <div class="h-2.5 rounded-full bg-indigo-500" style="width:${percent}%"></div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderDepartmentMix(actions) {
    const host = document.getElementById('departmentMixList');
    if (!host) return;

    const active = (actions || []).filter((action) => !action.is_terminal);
    if (!active.length) {
      host.innerHTML = '<p class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-5 text-center text-sm text-slate-500">No active queue items.</p>';
      return;
    }

    const counts = {};
    active.forEach((action) => {
      const key = action.queue_department || action.department || 'Unknown';
      counts[key] = (counts[key] || 0) + 1;
    });

    const total = active.length;
    const rows = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    host.innerHTML = rows.map(([name, count]) => {
      const pct = Math.round((count / total) * 100);
      return `
        <div class="flex items-center justify-between text-sm">
          <span class="text-slate-600">${name}</span>
          <span class="font-semibold text-slate-700">${count} (${pct}%)</span>
        </div>
      `;
    }).join('');
  }

  function renderRecentActivity(events) {
    const host = document.getElementById('recentActivityList');
    if (!host) return;

    if (!events || !events.length) {
      host.innerHTML = '<p class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-6 text-center text-sm text-slate-500">No recent activity available.</p>';
      return;
    }

    host.innerHTML = events.slice(0, 8).map((event) => {
      const title = event.action_title || event.action_type || 'Workflow event';
      const patientName = event.patient_name || ('Patient #' + (event.patient_id || '—'));
      const actor = event.actor_name || 'System';
      const state = event.new_state || '';
      const stateTone = ['FAILED', 'CANCELLED'].includes(state) ? 'rose' : ['COMPLETED', 'ADMINISTERED', 'CLOSED', 'RECORDED'].includes(state) ? 'emerald' : 'amber';
      const stateClass = stateTone === 'rose' ? 'bg-rose-100 text-rose-700' : stateTone === 'emerald' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700';
      return `
        <div class="rounded-xl border border-slate-200 px-4 py-3">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-sm font-medium text-slate-700">${title}</p>
              <p class="mt-1 text-xs text-slate-500">${patientName} · ${actor}</p>
            </div>
            <span class="rounded-full px-2 py-1 text-[10px] font-semibold uppercase tracking-wide ${stateClass}">${state || 'UPDATED'}</span>
          </div>
          <p class="mt-2 text-xs text-slate-400">${formatRelative(event.timestamp)}</p>
        </div>
      `;
    }).join('');
  }

  async function loadDashboard() {
    try {
      const [patients, actionsPayload, escalationsPayload, analyticsPayload, auditPayload] = await Promise.all([
        fetchAllPatients(),
        safeFetch('/actions'),
        safeFetch('/actions/escalations'),
        safeFetch('/analytics'),
        safeFetch('/audit-log?page=1&page_size=8')
      ]);

      const actions = Array.isArray(actionsPayload) ? actionsPayload : [];
      const escalations = Array.isArray(escalationsPayload) ? escalationsPayload : [];

      const totalPatients = Number(patients.length || 0);
      const activeTasks = actions.filter((action) => !action.is_terminal).length;
      const overdueTasks = actions.filter((action) => action.is_overdue).length;

      let slaText = '--';
      let slaSub = 'SLA insights available for doctor/admin roles';
      const hasAnalytics = analyticsPayload && !analyticsPayload.__forbidden;
      if (hasAnalytics && analyticsPayload.sla_compliance && analyticsPayload.sla_compliance.overall) {
        const rate = Number(analyticsPayload.sla_compliance.overall.rate || 0);
        slaText = rate.toFixed(1) + '%';
        slaSub = fmtNumber(analyticsPayload.sla_compliance.overall.compliant || 0) + ' compliant / ' + fmtNumber(analyticsPayload.sla_compliance.overall.total || 0) + ' tracked';
      }

      document.getElementById('metricTotalPatients').textContent = fmtNumber(totalPatients);
      document.getElementById('metricTotalPatientsSub').textContent = fmtNumber(patients.filter((p) => p.is_active !== false).length) + ' currently active';
      document.getElementById('metricActiveTasks').textContent = fmtNumber(activeTasks);
      document.getElementById('metricActiveTasksSub').textContent = fmtNumber(actions.length) + ' total workflow actions';
      document.getElementById('metricOverdueTasks').textContent = fmtNumber(overdueTasks);
      document.getElementById('metricOverdueTasksSub').textContent = fmtNumber(escalations.length) + ' escalations currently open';
      document.getElementById('metricSlaCompliance').textContent = slaText;
      document.getElementById('metricSlaComplianceSub').textContent = slaSub;

      const throughputRows = hasAnalytics ? (analyticsPayload.department_throughput || []) : [];
      renderThroughput(throughputRows);
      renderDepartmentMix(actions);

      const recentEvents = (auditPayload && !auditPayload.__forbidden) ? (auditPayload.events || []) : [];
      renderRecentActivity(recentEvents);

      const urgentActions = actions.filter((action) => !action.is_terminal && String(action.priority).toUpperCase() === 'URGENT').length;
      const referralActions = actions.filter((action) => !action.is_terminal && String(action.action_type).toUpperCase() === 'REFERRAL').length;
      document.getElementById('watchCritical').textContent = fmtNumber(escalations.length) + ' critical escalations';
      document.getElementById('watchUrgent').textContent = fmtNumber(urgentActions) + ' urgent actions';
      document.getElementById('watchReferrals').textContent = fmtNumber(referralActions) + ' referral actions';
    } catch (error) {
      showToast('Failed to load dashboard: ' + error.message, 'error');
    }
  }

  document.getElementById('refreshDashboardButton')?.addEventListener('click', loadDashboard);

  loadDashboard();
  setInterval(function() {
    if (document.visibilityState === 'visible') {
      loadDashboard();
    }
  }, 20000);
  window.addEventListener('focus', loadDashboard);
</script>
{% endblock %}
